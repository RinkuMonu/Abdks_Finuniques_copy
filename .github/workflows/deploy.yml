name: Deploy abdks.com React Build to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install & Build React (CRA)
        run: |
          npm install
          CI=false npm run build   # CI=false -> warnings pe build fail na ho

      - name: ğŸ—œ Tar production build
        run: |
          tar -czvf build.tar.gz -C build .

      # â†‘ ab build.tar.gz bana liya (sirf final static files)

      - name: ğŸš€ Upload build.tar.gz to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "build.tar.gz"
          target: "/home/abdks.com_deploy/"

      - name: ğŸ” SSH into EC2 and deploy to Nginx dir
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            set -e

            LIVE_DIR="/home/abdks.com/public_html"
            TMP_DIR="/home/abdks.com_deploy"
            BACKUP_DIR="/home/abdks.com_backups"

            echo "ğŸ“‚ Create helper dirs if not exists"
            mkdir -p $TMP_DIR
            mkdir -p $BACKUP_DIR

            echo "ğŸ›Ÿ Take timestamped backup of current live site"
            ts=$(date +%Y%m%d_%H%M%S)
            if [ -d "$LIVE_DIR" ]; then
              cp -r $LIVE_DIR $BACKUP_DIR/public_html_$ts || true
            fi

            echo "ğŸ§¹ Clean old live files"
            rm -rf $LIVE_DIR/*
            mkdir -p $LIVE_DIR

            echo "ğŸ“¦ Extract new build to live dir"
            tar -xzvf $TMP_DIR/build.tar.gz -C $LIVE_DIR
            rm $TMP_DIR/build.tar.gz

            echo "ğŸ‘‘ Fix nginx ownership"
            chown -R nginx:nginx $LIVE_DIR

            echo "âœ… Deploy complete for abdks.com"
